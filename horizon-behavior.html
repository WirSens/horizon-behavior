<link rel="import" href="../polymer/polymer.html">

<script>
    WIRSENS = window.WIRSENS || {};

    var isLoading = false;

    /* @polymerBehavior */
    WIRSENS.HorizonBehavior = {

        properties: {

            _horizonHost: String,
            _horizonPort: String,

            _horizon: {
                type: Object,
                computed: '_computeHorizon(_horizonHost, _horizonPort, _isReady)',
                notify: true
            },

            _libLoadedHandler: {
                value: function () {
                    return this._handleLibLoaded;
                }
            }
        },

        observers: [
            '_loadLib(_horizonHost, _horizonPort)'
        ],

        attached: function () {
            this._eventName = 'wirsens-horizon-script-loaded';
            var config = new Polymer.IronMetaQuery().byKey('horizon-config');

            this._horizonHost = !!config ? config.host : 'localhost';
            this._horizonPort = !!config ? config.port : '8181';

            window.addEventListener(this._eventName, this._libLoadedHandler.bind(this));
        },

        _handleLibLoaded: function () {
            this._isReady = true;
        },

        _loadLib: function (host, port) {

            // check if someone else is loading
            if (isLoading) {
                return;
            }

            // we're first, let's load it
            isLoading = true;

            var script = document.createElement('script');
            script.id = 'horizonScript';

            if (document.querySelector('#horizonScript')) {
                return;
            }

            var src = host + ':' + port;

            if (/ngrok.io/.test(location.hostname)) {
                src = location.hostname.replace('seats', 'horizon');
            }

            script.src = '//' + src + '/horizon/horizon.js';
            document.head.appendChild(script);

            script.onload = function () {
                isLoading = false;
                this.fire(this._eventName, {}, { node: window });
            }.bind(this);
        },

        _computeHorizon: function (host, port) {
            var hostString = host + ':' + port;

            if (/ngrok.io/.test(location.hostname)) {
                hostString = location.hostname.replace('seats', 'horizon');
            }

            return Horizon({
                host: hostString
            });
        },

        detached: function () {
            window.removeEventListener(this._eventName, this._handleLibLoaded);
        }
    };
</script>
