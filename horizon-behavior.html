<link rel="import" href="bower_components/polymer/polymer.html">

<script>
    WIRSENS = window.WIRSENS || {};

    var isReady = false;

    /* @polymerBehavior */
    WIRSENS.HorizonBehavior = {

        properties: {

            _horizonHost: String,
            _horizonPort: String,

            _horizon: {
                type: Object,
                computed: '_computeHorizon(_horizonHost, _horizonPort, _isReady)',
                notify: true
            }
        },

        observers: [
            '_loadLib(_horizonHost, _horizonPort)'
        ],

        ready: function () {

            var config = new Polymer.IronMetaQuery().byKey('horizon-config');

            this._horizonHost = !!config ? config.host : 'localhost';
            this._horizonPort = !!config ? config.port : '8181';
        },

        _loadLib: function (host, port) {
            var script = document.createElement('script');
            script.id = 'horizonScript';

            if (document.querySelector('#horizonScript')) {
                if (isReady) {
                    this._isReady = true;
                }
                return;
            }

            var src = host + ':' + port;

            if (/ngrok.io/.test(location.hostname)) {
                src = location.hostname.replace('seats', 'horizon');
            }


            script.src = '//' + src + '/horizon/horizon.js';
            document.head.appendChild(script);

            script.onload = function () {
                isReady = true;
                this._isReady = true;
            }.bind(this);
        },

        _computeHorizon: function (host, port) {
            var hostString = host + ':' + port;

            if (/ngrok.io/.test(location.hostname)) {
                hostString = location.hostname.replace('seats', 'horizon');
            }

            return Horizon({
                host: hostString
            });
        }
    };
</script>
